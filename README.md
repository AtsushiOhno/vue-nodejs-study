## Vue.js + Node.js(Express) + DB + オマケの簡易勉強環境

フロントエンドをVue.jsで、バックエンドをNode.jsという簡易的な学習環境を作りました。
極力シンプルに押さえたつもりなので、手を入れやすいと思います。

ちなみに、Vue.js完全初体験な人が4時間程度で作っています。WebフロントエンジニアでもなければJavascriptに詳しいわけでもないようです。

### 特徴

* 学習のためのシンプルかつ拡張のための基本的な機能を備えた環境
* Vue.jsをフロントエンドに使用
* Node.js(Express)でバックエンドAPIサーバを実現
* APIサーバに外部からデータを供給するための簡易な疑似センサーデバイスを用意
* APIサーバには簡易的なDBサーバ(sqlite3)を用意
* docker-composeによる環境の全自動構築
* フロントエンドをjQueryとかReactに変えても動くはず、そらそうよ。

---
### 概要

Node.js(Express)で簡易的なAPIサーバを作成し、データの蓄積と受け渡しを行います。
ブラウザ側(クライアント側)ではVue.jsが動作しており、APIサーバ上の情報を非同期的に取得して
htmlの構成要素を書き換えます。
またAPIサーバへデータを提供するために疑似的なセンサーデバイスをpythonでシミュレートしており、
1秒間に1度のペースで室温、湿度、気圧をランダム生成し、APIサーバへデータを送信(POST)することで、
APIサーバにデータがたまる仕組みになっています。
APIサーバにはDBが備わっており、APIを改造することで過去のデータを取得できるなどの機能拡張にも便利です。

---
### 構成図

![構成図](./doc/arch.svg?raw=true)

---
### How to install

このリポジトリをクローンして、`docker-compose up -d`をたたくだけです。

---
### How to use

* ブラウザを起動して、localhost:8080へアクセスしてください。
* index.htmlの見栄えが悪い？豪華にしたら見るべきところがわかりにくいでしょう？
* 見栄えをよくするならbootstrapやVue.jsのためのデザインフレームワークがあるらしいのでそれを使いましょう。

![画面](./doc/screen.png?raw=true)

---
### APIサーバ（兼一般的なWebサーバ）

Swaggerで書きなさいといわれそうですが、それはまた気が向いたら。。。

|path|method|is何|
|----|------|----|
| /                 | GET  | index.htmlを返します |
| /vue_app.js       | GET  | vue_app.jsを返します |
| /api/v1/roomdata  | GET  | 最新のセンサーデータを返します。[{time: int, room_temp: float, room_humid: float, room_pressure: float}] |
| /api/v1/roomdata  | POST | センサーデータを登録します。{time: int, room_temp: float, room_humid: float, room_pressure: float} |
| /api/v1/memo      | GET  | メモデータを全部返します。[{message: text}] |
| /api/v1/memo      | POST | メモデータを登録します。{message: text} |

---
### 実装されている簡易アプリ

大したものは1つもない

|アプリ|is何|
|------|----|
|時計 | ド定番。クライアントのローカルタイムを取得して表示しているだけ。API通信なし|
|温度、湿度、気圧表示 | APIサーバからデータを受信して値を更新している。データは疑似センサープログラムからAPIサーバへ提供されたもの|
|食べ放題受付ペッパー君 | クライアントサイドで動作。人数の変化をトリガに料金を即時計算し表示する。これもAPI通信なし|
|メモアプリ | ボタン押下をトリガにAPIサーバ上にメモ内容を送信したり、APIサーバからメモ内容を受信したり表示したりする。|
---
### 改造のための手引き

どこに何がおかれているのか、どういう意味があるのかを簡単に。

#### ファイル構成
まず、コンテナ毎にディレクトリを用意しています。
```
{container名}
  ├ file  #ビルド時にコンテナに焼きこむためのファイル
  ├ vol   #コンテナにマウントする永続化ボリューム
  └ Dockerfile   #コンテナビルドのための設計書

docker-compose.yml #NW、Volume、ビルド等の情報をまとめる設計書（雑な説明）
```
----

#### nodejs-backend

APIサーバ、DB（sqlite3）を提供するコンテナ。Vue.jsを含んだhtmlを配信するWebサーバもかねている。

| file | 解説 |
|------|------|
| file/index.js | APIサーバの中核部分。APIのパスや挙動をここに書きます。コンテナに焼きこんでいるので、変更する場合は`docker-compose up -d --build`等してください|
| file/package.json | Node.jsに追加するライブラリをここに書きます。現状は`express, sqlite3, body-parser`を追加しています。今回は書いていないですが、開発環境にだけ入れたいモジュールは`devDependencies`に書きます。|
| vol/html/index.html | 見ての通りindex.htmlです。ブラウザで描画するメインのhtmlです。中を見ればVue.jsが読み込まれていて、ここがVue.jsで書き換えられるんだろうなと直観でもわかるかと思います。このファイルはボリューム上にあるので、書き換えれば即時反映されます。 |
| vol/html/vue_app.js | 今回の学習の肝です？APIサーバと非同期通信し、htmlの構成要素を書き換える部分です。今回の例では時計(500ms毎更新)と、センサーデータの表示(5s毎更新)を実装しています。もちろん、クリックで取得などの機能拡張も可能。 |

---
#### python-simulated-sensor-device

なんちゃってセンサーコンテナ。

おまけのデータ生成器で基本的にいじることはなさそうですが一応。
改造してログ生成器にするなり、煮るなり焼くなりお好きに。
というほど、高機能でもないんですが。。。

| file | 解説 |
|------|------|
| file/myapp.py | 1秒間に1度室温、湿度、気圧データを生成してAPIに送りつけます。見りゃわかるかと。本物が欲しければ秋月がどこかでBME280とか買いましょう。 |
| file/requirements.txt | ビルド時にpipにインストールしたいpythonモジュールはここに書きます。 |

---
### 注意事項

* コンテナはrootで実行されています。
* APIサーバでのエラー処理は皆無に等しいです。

---

### その他言い訳っぽいもの

* javascriptがそもそも覚束ない、どこから勉強すればいいかわからない人はCodeacademyの無料コースを受講してみるとよいかも。
* APIのレスポンスが正常時とエラー時でキーが変わるのでAPI的によろしくない実装。

---
### ToDo

* ポート変更しやすくしましょう。
* 勉強と家のIoTっぽいデバイスのリプレースをこのアーキテクチャベースでやろう。
* swagger書こう。ついでにswagger Editorもホストするようにする？